---
layout: post
title: "Linux CPU monitor"
description: ""
category:
tags: [linux]
---
{% include JB/setup %}

# Linux 系统下几种常用的CPU监控命令

`cpu`是整个操作系统的核心，整个操作系统的运行状态，跟`cpu`有着重要的关系。
我们可以通过一些常用工具和命令，获取`cpu`的监控信息。
从监控信息能看到

* top
* mpstat
* sar –p
* perf
* pidstat
* uptime
* ps
* /proc/cpuinfo


## top
Linux的任务管理器 `display Linux tasks`
多核模式, 1/I: 切换smp模式，观察每个SMP CPU 的使用率

```
Tasks: 349 total,   1 running, 347 sleeping,   0 stopped,   1 zombie
load average: 0.18, 0.26, 0.32
Cpu0  :  0.3%us,  0.3%sy,  0.0%ni, 99.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu1  : 10.4%us,  1.8%sy,  0.0%ni, 87.8%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu2  :  3.7%us,  0.9%sy,  0.0%ni, 95.4%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu3  :  0.6%us,  0.3%sy,  0.0%ni, 99.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
```

* load average: 0.18, 0.26, 0.32: [系统负载，即任务队列的平均长度]， 分别是 1分钟，5分钟，15分钟时间内的平均的队列长队，该长度反应了系统负载的变化情况。
* Cpu(s):
 1. 3.9%us [用户空间占用CPU百分比]
 2. 0.6%sy [内核空间占用CPU百分比]
 3. 0.0%ni [用户进程空间内改变过优先级的进程占用CPU百分比] nice 的进程百分比
 4. 95.4%id [空闲CPU百分比]
 5. 0.0%wa [等待输入输出的CPU时间百分比]
 6. 0.0%hi [系统花在处理hardware interrupt的时间百分比]
 7. 0.1%si [系统花在处理softare interrupt的时间百分比]
 8. 0.0%st [虚拟化管理程序，xen/kvm 等]


```
KiB Mem : 39431625+total,   505616 free, 35967712+used, 34133516 buff/cache
KiB Swap:        0 total,        0 free,        0 used. 26684268 avail Mem
```

* Mem: 4147888k total[物理内存总量]
* 2493092k used[使用的物理内存总量]
* 1654796k free[空闲内存总量]
* 158188k buffers[用作内核缓存的内存量]
* Swap:  5144568k total[交换区总量]
* 56k used[使用的交换区总量]
* 5144512k free[空闲交换区总量]
* 2013180k cached[缓冲的交换区总量]

进程详细信息，每列含义：


序号 | 列名 | 含义
----- | ----- | -----
a    |PID|     进程id
b    |PPID    |父进程id
c    |RUSER   |Real user name
d    |UID     |进程所有者的用户id
e    |USER    |进程所有者的用户名
f    |GROUP   |进程所有者的组名
g    |TTY     |启动进程的终端名。不是从终端启动的进程则显示为 ?
h    |PR      |优先级
i    |NI      |nice值。负值表示高优先级，正值表示低优先级
j    |P       |最后使用的CPU，仅在多CPU环境下有意义
k    |%CPU    |上次更新到现在的CPU时间占用百分比
l    |TIME    |进程使用的CPU时间总计，单位秒
m    |TIME+   |进程使用的CPU时间总计，单位1/100秒
n    |%MEM    |进程使用的物理内存百分比
o    |VIRT    |进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES
p    |SWAP    |进程使用的虚拟内存中，被换出的大小，单位kb。
q    |RES     |进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA
r    |CODE    |可执行代码占用的物理内存大小，单位kb
s    |DATA    |可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb
t    |SHR     |共享内存大小，单位kb
u    |nFLT   | 页面错误次数
v    |nDRT  |  最后一次写入到现在，被修改过的页面数。
w    |S      | 进程状态(D=不可中断的睡眠状态,R=运行,S=睡眠,T=跟踪/停止,Z=僵尸进程)
x    |COMMAND |命令名/命令行
y    |WCHAN |  若该进程在睡眠，则显示睡眠中的系统函数名
z    |Flags|   任务标志，参考 sched.h

## mpstat

查看多 cpu 的统计信息 Report processors related statistics

```
mpstat [-P {|ALL}] [internal [count]]
mpstat -P 0 1 1
Linux 3.10.0-693_21.tl2 (kvm_9_16_45_154) 	03/29/19 	_x86_64_	(80 CPU)

18:39:42     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
```

* %user      在internal时间段里，用户态的CPU时间(%)，不包含nice值为负进程  (usr/total)*100
* %nice      在internal时间段里，nice值为负进程的CPU时间(%)   (nice/total)*100
* %sys       在internal时间段里，内核时间(%)       (system/total)*100
* %iowait    在internal时间段里，硬盘IO等待时间(%) (iowait/total)*100
* %irq       在internal时间段里，硬中断时间(%)     (irq/total)*100
* %soft      在internal时间段里，软中断时间(%)     (softirq/total)*100
* %idle      在internal时间段里，CPU除去等待磁盘IO操作外的因为任何原因而空闲的时间闲置时间(%) (idle/total)*100


## sar –P
参考[linux 工具 - sar](https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/sar.html)

sar是System Activity Reporter（系统活动情况报告), sar是目前Linux上最为全面的系统性能分析工具之一，可以从14个大方面对系统的活动进行报告。 生成文件。

```
# 查看cpu 1， 没间隔1秒获取一次数据，共执行一次
sar -P 1 1 1
Linux 3.10.0-693_21.tl2 (kvm_9_16_45_154) 	03/29/19 	_x86_64_	(80 CPU)

18:53:53        CPU     %user     %nice   %system   %iowait    %steal     %idle
18:53:54          1      0.00      0.00      0.00      0.00      0.00    100.00
Average:          1      0.00      0.00      0.00      0.00      0.00    100.00
```

sar –u 查看是否有cpu 瓶颈
